###############################################################################
#                                   BUILDX                                    #
###############################################################################

FROM --platform=linux/amd64 docker AS buildx
COPY --from=docker/buildx-bin /buildx /usr/libexec/docker/cli-plugins/docker-buildx
RUN docker buildx version


###############################################################################
#                              CI BUILDER (BASE)                              #
###############################################################################

FROM --platform=linux/amd64 debian:bullseye-slim AS base-builder

# Use bash as the shell
SHELL ["/bin/bash", "-c"]
ENV SHELL=/bin/bash
ENV BASH=/bin/bash

# Copy mise configuration
COPY ./mise.toml ./mise.toml

# Set up mise environment
ENV PATH="/root/.local/share/mise/shims:$PATH"
ENV PATH="/root/.local/bin:${PATH}"

# Install dependencies
# We do this in one mega RUN command to avoid blowing up the size of the image
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && \
  apt-get install -y build-essential git clang lld curl jq

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > rustup.sh && \
  chmod +x ./rustup.sh && \
  sh rustup.sh -y

# Install nightly toolchain
RUN source $HOME/.profile && rustup update nightly

RUN source $HOME/.profile && cargo install just
RUN source $HOME/.profile && cargo install svm-rs --version 0.5.7

# Only diff from upstream docker image is this clone instead
# of COPY. We select a specific commit to use.
COPY ./versions.json ./versions.json
COPY ./ops/scripts/install-foundry.sh ./install-foundry.sh

RUN curl -L https://foundry.paradigm.xyz | bash
RUN source $HOME/.profile && ./install-foundry.sh

RUN strip /root/.foundry/bin/forge && \
  strip /root/.foundry/bin/cast && \
  strip /root/.foundry/bin/anvil && \
  strip /root/.cargo/bin/svm && \
  strip /root/.cargo/bin/just

FROM --platform=linux/amd64 debian:bullseye-slim as go-build

RUN apt-get update && apt-get install -y curl ca-certificates jq binutils

ENV GO_VERSION=1.22.7

# Fetch go manually, rather than using a Go base image, so we can copy the installation into the final stage
RUN curl -sL https://go.dev/dl/go$GO_VERSION.linux-amd64.tar.gz -o go$GO_VERSION.linux-amd64.tar.gz && \
  tar -C /usr/local/ -xzvf go$GO_VERSION.linux-amd64.tar.gz

ENV GOPATH=/go
ENV PATH=/usr/local/go/bin:$GOPATH/bin:$PATH

# Install the specific version of abigen and geth from version control
COPY ./versions.json ./versions.json
RUN go install github.com/ethereum/go-ethereum/cmd/abigen@$(jq -r .abigen < versions.json)
RUN go install github.com/ethereum/go-ethereum/cmd/geth@$(jq -r .geth < versions.json)

RUN go install gotest.tools/gotestsum@v1.12.0
RUN go install golang.org/x/tools/cmd/goimports@latest
RUN go install github.com/vektra/mockery/v2@v2.46.0
RUN go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.61.0
RUN go install github.com/mikefarah/yq/v4@v4.44.3

# Strip binaries to reduce size
RUN strip /go/bin/gotestsum && \
  strip /go/bin/mockery && \
  strip /go/bin/golangci-lint && \
  strip /go/bin/abigen && \
  strip /go/bin/geth && \
  strip /go/bin/yq

FROM --platform=linux/amd64 debian:bullseye-slim as base-builder

ENV GOPATH=/go
ENV PATH=/usr/local/go/bin:$GOPATH/bin:$PATH
ENV PATH=/root/.cargo/bin:$PATH
ENV DEBIAN_FRONTEND=noninteractive

# copy the go installation, but not the module cache (cache will get stale, and would add a lot of weight)
COPY --from=go-build /usr/local/go /usr/local/go

# copy tools
COPY --from=go-build /go/bin/gotestsum /go/bin/gotestsum
COPY --from=go-build /go/bin/mockery /go/bin/mockery
COPY --from=go-build /go/bin/golangci-lint /go/bin/golangci-lint
COPY --from=go-build /go/bin/goimports /go/bin/goimports
COPY --from=go-build /go/bin/abigen /usr/local/bin/abigen
COPY --from=go-build /go/bin/geth /usr/local/bin/geth
COPY --from=go-build /go/bin/yq /go/bin/yq

# copy tools
COPY --from=rust-build /root/.foundry/bin/forge /usr/local/bin/forge
COPY --from=rust-build /root/.foundry/bin/cast /usr/local/bin/cast
COPY --from=rust-build /root/.foundry/bin/anvil /usr/local/bin/anvil
COPY --from=rust-build /root/.cargo/bin/svm /usr/local/bin/svm
COPY --from=rust-build /root/.cargo/bin/just /usr/local/bin/just

COPY ./versions.json ./versions.json

RUN /bin/sh -c set -eux; \
  apt-get update; \
  apt-get install -y --no-install-recommends bash curl openssh-client git build-essential ca-certificates gnupg binutils-mips-linux-gnu clang libffi-dev; \
  mkdir -p /etc/apt/keyrings; \
  curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg; \
  chmod a+r /etc/apt/keyrings/docker.gpg; \
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null; \
  apt-get update; \
  apt-get install -y docker-ce-cli; \
  curl https://mise.run | sh; \
  mise trust ./mise.toml; \
  mise install; \
  curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | bash; \
  pip install capstone pyelftools; \
  go env -w GOMODCACHE=/go/pkg/mod; \
  go env -w GOCACHE=/root/.cache/go-build; \
  ln -s /usr/local/go/bin/gofmt /usr/local/bin/gofmt; \
  apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \
  go clean -cache -modcache -testcache; \
  rm -rf /var/lib/apt/lists/*; \
  rm -rf /root/.cache/pip; \
  rm -rf /root/.cache/uv; \
  rm -rf /root/.rustup;

# Install Solidity versions
RUN echo "installing Solidity versions" && \
  svm install 0.8.25 && \
  svm install 0.8.19 && \
  svm install 0.8.15

# Install Codecov uploader
RUN echo "downloading and verifying Codecov uploader" && \
  curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import && \
  curl -Os "https://uploader.codecov.io/latest/linux/codecov" && \
  curl -Os "https://uploader.codecov.io/latest/linux/codecov.SHA256SUM" && \
  curl -Os "https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig" && \
  gpgv codecov.SHA256SUM.sig codecov.SHA256SUM && \
  shasum -a 256 -c codecov.SHA256SUM || sha256sum -c codecov.SHA256SUM && \
  cp codecov /usr/local/bin/codecov && \
  chmod +x /usr/local/bin/codecov  && \
  rm codecov

# Copy docker buildx
COPY --from=buildx /usr/libexec/docker/cli-plugins/docker-buildx /usr/libexec/docker/cli-plugins/docker-buildx

# Set up entrypoint
ENTRYPOINT ["/bin/bash", "-c"]


###############################################################################
#                              CI BUILDER (RUST)                              #
###############################################################################

FROM base-builder as rust-builder

# Install clang & lld
RUN apt-get update && apt-get install -y clang lld

# Install nightly toolchain
RUN rustup update nightly

# Install parallel
RUN apt-get install -y parallel

# Copy the rust installation, alongside the installed toolchains
COPY --from=rust-build /root/.cargo /root/.cargo
COPY --from=rust-build /root/.rustup /root/.rustup

# copy the rust installation, alongside the installed toolchains
COPY --from=rust-build /root/.cargo/bin /root/.cargo/bin
COPY --from=rust-build /root/.rustup /root/.rustup
